#
# This script snippet prepares a VM when using SLES or Leap based
# images.
#
# Outputs:
#  $ibs_build_target
#	can be used by subsequent script snippets in building
#	IBS repository names.
#  $sle_module_version (SLE only)
#	can be used by subsequent script snippets to register
#	additional modules
#
# Side effects:
#  -	a set of "useful" repos have been registered and enabled
#
case $TWOPENCE_OS in
SLES*-SP*)
	eval $(echo "$TWOPENCE_OS" | sed 's:SLES\\(.*\\)-SP\\(.*\\):MAJOR=\\1 MINOR=\\2:')
	ibs_build_target=SLE_${MAJOR}_SP$MINOR
	sle_module_version=$MAJOR.$MINOR
	: ;;
Leap-*.*)
	ibs_build_target="${TWOPENCE_OS#Leap-}"
	: ;;
*)
	echo "Unidentified OS %s - don't know what IBS build target to use" >&2
	exit 1;;
esac

case $TWOPENCE_OS in
SLE*)
	if [ -z "$TWOPENCE_INFO_SUSE_REGISTRATION_REGCODE" -o -z "$TWOPENCE_INFO_SUSE_REGISTRATION_EMAIL" ]; then
		echo "Error: cannot register $TWOPENCE_OS system; lacking regcode and/or email" >&2
		exit 1
	else
		SUSEConnect -r "$TWOPENCE_INFO_SUSE_REGISTRATION_REGCODE" -e "$TWOPENCE_INFO_SUSE_REGISTRATION_EMAIL"
		SUSEConnect -p sle-module-desktop-applications/$sle_module_version/$TWOPENCE_ARCH
		SUSEConnect -p sle-module-development-tools/$sle_module_version/$TWOPENCE_ARCH
		SUSEConnect --list-extensions
	fi
	: ;;
esac

zypper lr

# For some reason, the backports repo is causing a zypper refresh error right now...
if [ "$TWOPENCE_OS" = "Leap-15.3" ]; then
	zypper mr -d repo-backports-update
fi

# These probably shouldn't be here; I'm installing them because I find them
# useful in debugging
zypper -n in -y wget strace

set -e

infra_repo_url=https://download.opensuse.org/repositories/openSUSE:/infrastructure/$ibs_build_target
rpm --import $infra_repo_url/repodata/repomd.xml.key
zypper -n addrepo $infra_repo_url infrastructure
zypper -n refresh
zypper -n install ca-certificates-suse
zypper mr -d infrastructure

set +e
