# -*- mode: ruby -*-
# vi: set ft=ruby :
# Template for Vagrantfile to provision a (SUSE based) silver image with selinux
# enablement

# TBD: based on the requirements, change how we provision.
# E.g. if the requirements include "suse-registration", provisioning should
# perform the SUSEConnect dance.
requires = Array[
	"@REQUIRES@",
]

Vagrant.configure("2") do |config|
  config.vm.box = "@IMAGE@"

  config.vm.provision "shell", inline: <<-SHELL
     os="@OS@"
     arch="@ARCH@"

     case $os in
     SLES15-SP3)
	ibs_build_target=SLE_15_SP3
	sle_module_version=15.3
	: ;;
     esac

     case $os in
     SLE*)
	SUSEConnect -r "@INFO_REGISTRATION_REGCODE@" -e "@INFO_REGISTRATION_EMAIL@"
	SUSEConnect -p sle-module-desktop-applications/$sle_module_version/$arch
	SUSEConnect -p sle-module-development-tools/$sle_module_version/$arch
	SUSEConnect --list-extensions
	: ;;
     esac

     zypper -n in -y wget strace

     zypper -n addrepo https://download.opensuse.org/repositories/openSUSE:infrastructure/$ibs_build_target/openSUSE:infrastructure.repo
     zypper -n refresh
     zypper -n --gpg-auto-import-keys install ca-certificates-suse

     zypper -n ar --no-gpgcheck https://download.suse.de/ibs/home:/okir:/selinux/$ibs_build_target selinux
     zypper -n up -y --allow-vendor-change libselinux1 selinux-tools
     zypper -n in -y --allow-vendor-change checkpolicy policycoreutils restorecond
     zypper -n in -y --allow-vendor-change selinux-policy-targeted selinux-autorelabel

     echo "Updating kernel command line"
     for w in security=selinux selinux=1 enforcing=0 console=ttyS0; do
     	/usr/sbin/sysconf_addword /etc/default/grub GRUB_CMDLINE_LINUX_DEFAULT $w
     done
     /sbin/update-bootloader

     systemctl enable restorecond.service

     selinux-ready

     # reboot
   SHELL

   config.vm.provision :shell do |shell|
     shell.privileged = true
     shell.inline = 'echo rebooting'
     shell.reboot = true
   end

  config.vm.provision "shell", inline: <<-SHELL
     selinux-ready
  SHELL
end
